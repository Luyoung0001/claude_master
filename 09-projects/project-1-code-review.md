# 项目一：智能代码审查系统

构建一个自动化的代码审查系统，集成 GitHub PR 工作流。

---

## 项目目标

- 自动审查 Pull Request
- 检测代码质量问题
- 生成审查报告
- 提供修复建议

---

## 项目结构

```
code-review-system/
├── .claude/
│   ├── settings.json       # 配置文件
│   └── commands/
│       ├── review-pr.md    # PR 审查命令
│       ├── review-file.md  # 文件审查命令
│       └── security.md     # 安全审查命令
├── scripts/
│   └── review-hook.sh      # Hook 脚本
└── templates/
    └── review-report.md    # 报告模板
```

---

## 步骤 1：配置 MCP 和权限

```json
// .claude/settings.json
{
  "mcpServers": {
    "github": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-github"],
      "env": {
        "GITHUB_TOKEN": "${GITHUB_TOKEN}"
      }
    }
  },
  "permissions": {
    "allow": [
      "Read",
      "Bash(git:*)",
      "Bash(npm run lint:*)",
      "Bash(npm test:*)"
    ]
  },
  "hooks": {
    "PostToolUse": [
      {
        "matcher": {
          "toolName": "Write",
          "inputMatches": "\\.ts$"
        },
        "hooks": [
          {
            "type": "command",
            "command": "npx eslint \"$FILE_PATH\" --format compact 2>&1 | head -20 || true"
          }
        ]
      }
    ]
  }
}
```

---

## 步骤 2：创建审查命令

### PR 审查命令

```markdown
<!-- .claude/commands/review-pr.md -->
审查 GitHub Pull Request：$ARGUMENTS

执行以下步骤：

## 1. 获取 PR 信息
- 使用 GitHub MCP 获取 PR 详情
- 获取所有变更的文件列表
- 获取 PR 描述和评论

## 2. 代码分析
对每个变更的文件：
- 读取文件内容
- 检查代码质量
- 识别潜在问题

## 3. 检查项目

### 代码质量
- [ ] 代码是否清晰可读
- [ ] 命名是否规范
- [ ] 是否有重复代码
- [ ] 函数长度是否合理

### 潜在问题
- [ ] 是否有明显 bug
- [ ] 边界条件是否处理
- [ ] 错误处理是否完善
- [ ] 是否有内存泄漏风险

### 安全性
- [ ] 是否有注入风险
- [ ] 敏感数据处理
- [ ] 权限检查

### 性能
- [ ] 是否有 N+1 查询
- [ ] 算法复杂度
- [ ] 资源使用

## 4. 生成报告
输出格式：

# Code Review Report

## 概述
[一句话总结]

## 发现的问题
| 严重程度 | 文件 | 行号 | 问题描述 | 建议 |
|---------|------|-----|---------|------|

## 优点
- [列出代码的优点]

## 建议
- [改进建议]

## 结论
- [ ] 批准
- [ ] 需要修改
- [ ] 需要讨论
```

### 文件审查命令

```markdown
<!-- .claude/commands/review-file.md -->
审查代码文件：$ARGUMENTS

1. 读取指定文件
2. 进行深度代码审查
3. 运行 lint 检查：npm run lint -- $ARGUMENTS
4. 分析测试覆盖情况

输出详细的审查报告。
```

### 安全审查命令

```markdown
<!-- .claude/commands/security.md -->
对以下代码进行安全审查：$ARGUMENTS

重点检查：
1. SQL 注入
2. XSS 攻击
3. CSRF 漏洞
4. 敏感信息泄露
5. 不安全的依赖
6. 权限问题
7. 加密问题

运行 npm audit 检查依赖漏洞。

输出安全审查报告。
```

---

## 步骤 3：创建 Hook 脚本

```bash
#!/bin/bash
# scripts/review-hook.sh

# Git pre-push hook 集成
# 将此脚本链接到 .git/hooks/pre-push

echo "Running code review..."

# 获取待推送的提交
commits=$(git log @{u}..HEAD --oneline)

if [ -z "$commits" ]; then
    echo "No commits to review"
    exit 0
fi

# 获取变更的文件
changed_files=$(git diff --name-only @{u}..HEAD)

echo "Files to review:"
echo "$changed_files"

# 调用 Claude 进行审查
echo "$changed_files" | while read file; do
    if [[ $file == *.ts ]] || [[ $file == *.js ]]; then
        echo "Reviewing $file..."
        claude -p "/review-file $file" 2>/dev/null || true
    fi
done

echo "Review complete!"
```

---

## 步骤 4：使用示例

### 审查 PR

```bash
# 设置 GitHub Token
export GITHUB_TOKEN="ghp_xxxx"

# 启动 Claude Code
claude

# 审查特定 PR
> /review-pr owner/repo#123

# 或者只审查当前分支的变更
> /review-file src/
```

### 自动化审查

```bash
# 在 CI/CD 中使用
claude -p "/review-pr $GITHUB_REPOSITORY#$PR_NUMBER" > review-report.md

# 将报告发布为 PR 评论
gh pr comment $PR_NUMBER --body-file review-report.md
```

---

## 步骤 5：报告模板

```markdown
<!-- templates/review-report.md -->
# Code Review Report

**PR**: #{{pr_number}}
**Author**: {{author}}
**Date**: {{date}}

## Summary
{{summary}}

## Issues Found

### Critical
{{#critical_issues}}
- **{{file}}:{{line}}** - {{description}}
{{/critical_issues}}

### Warnings
{{#warnings}}
- **{{file}}:{{line}}** - {{description}}
{{/warnings}}

### Suggestions
{{#suggestions}}
- {{description}}
{{/suggestions}}

## Code Quality Score
- Readability: {{readability}}/10
- Maintainability: {{maintainability}}/10
- Security: {{security}}/10

## Recommendation
{{recommendation}}

---
*Generated by Claude Code Review System*
```

---

## 扩展：持续集成

### GitHub Actions 集成

```yaml
# .github/workflows/code-review.yml
name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Run Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          claude -p "Review the changes in this PR: ${{ github.event.pull_request.number }}" > review.md

      - name: Post Review Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('review.md', 'utf8');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: review
            });
```

---

## 总结

本项目涵盖了：

- MCP GitHub Server 配置
- 自定义 Slash Commands
- Hooks 自动化
- CI/CD 集成

下一步：尝试添加更多检查规则，或集成其他代码分析工具。
